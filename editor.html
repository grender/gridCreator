<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8" />
<title></title>

<script type="text/javascript" src="./jquery.min.js"></script>

<script type="text/javascript">

function getLimitedFunction(obj, func, freqPerSecond) {
    if (typeof func !== "function") 
        throw new Error("Is not function in argument")

    var previousCheckTime = new Date().valueOf()
    var currentSecondCount = 0
    return function decoratedFunction() {
        var currentTime = new Date().valueOf()
        if (currentTime - previousCheckTime > 100) {
            previousCheckTime = currentTime
            currentSecondCount = 0
        }else {
            if (currentSecondCount >= freqPerSecond) 
                return
        }
        currentSecondCount++
        func.apply(obj, arguments)
    }
}


this.mainLoop=getLimitedFunction(this,function() {
	clearCanvas();
	drawGrid();
	drawBlocks();
	drawNewBlock();
},3)


var mousePressed=false;
var canvas;
var context;
var blocks=[];
var blockCandidate;

function drawBlocks() {
	for (var i=0; i < blocks.length; i++) {
		var block=blocks[i];
		drawBlock(block);
	};
}

function drawBlock(block)
{
	context.globalAlpha = 0.2;
	context.fillStyle="#aae";
	context.fillRect(block.x,block.y,block.width,block.height);
}

function drawNewBlock() {
	if(!blockCandidate) return;
	context.globalAlpha = 0.1;
	context.fillStyle="#aae";
	context.fillRect(blockCandidate.x,blockCandidate.y,blockCandidate.width,blockCandidate.height);	
}

function readParams()
{
	var nameRegExp=/(widht|height)+/g
	var res={};
	var childrens=$("#paramForm").children();
	for(var i=0;i<childrens.length;i++)
	{
		if(nameRegExp.test(childrens[i].id.toLowerCase()))
		{
			var typeParseRegExp=/([0-9]*)(em|pt|px)?/g;	
			var parsedInput=typeParseRegExp.exec(childrens[i].value);
			var val=parsedInput[1];
			var dim=parsedInput[2];
			if(!dim)
			{
				res[childrens[i].id]=parseFloat(val);			
			}else {
				res[childrens[i].id]=convert(val,dim,"px");			
			}
		}else {
			res[childrens[i].id]=parseFloat(childrens[i].value);			
		}
	}
	return res;
}

function convert(val,from,to)
{
	if(!val)
		return 0;
	var convertMtply={
		ptToPx:1.5,
		pxToEm: 1/16,
		ptToEm: 1/12
	};
	from=from.toLowerCase();
	to=to.toLowerCase();
	if(from==to)
		return parseFloat(val);
	if(from!="pt" && from!="em" && from!="px")
		throw new Error("error value type");
	if(to!="pt" && to!="em" && to!="px")
		throw new Error("error value type");
		
	var p1=from;
	var p2=to;
	var param=p1+"To"+p2[0].toUpperCase()+p2.slice(1);
	var mltply=1;
	if(convertMtply[param])
		mltply=convertMtply[param];
	else {
		param=p2+"To"+p1[0].toUpperCase()+p1.slice(1);
		if(convertMtply[param])
			mltply=1/convertMtply[param];
		else 
			throw new Error("not found this convert value");
	}
	return parseFloat(val)*mltply;
}


function drawGrid()
{
	context.lineWidth=1;
	context.strokeStyle = "#aaa";
	context.beginPath();
	for(var y=0;y<paramObj.fullHeight;y=y+paramObj.fontHeight*paramObj.interlinearFactor)
	{
		context.moveTo(0,y);
		context.lineTo(paramObj.fullWidth,y);
	}
	context.closePath();
	context.stroke();
	
	context.globalAlpha = 0.2;
	context.fillStyle="#eaa";
	for(var y=0;y<paramObj.fullHeight;y=y+paramObj.fontHeight*paramObj.interlinearFactor*(paramObj.horizBlockRowCount+1))
		context.fillRect(0, y, paramObj.fullWidth, paramObj.fontHeight*paramObj.interlinearFactor*paramObj.horizBlockRowCount);
	
	
	context.fillStyle="#faa";
	for(var i=0;i<paramObj.vetricalBlockCount;i++)
		context.fillRect(i*(paramObj.vetricalBlockWidth+paramObj.vetricalBlockSpacerWidth), 0,paramObj.vetricalBlockWidth , paramObj.fullHeight);
}

function clearCanvas()
{
	$("#mainCanvas")[0].width=paramObj.fullWidth;
	$("#mainCanvas")[0].height=paramObj.fullHeight;
}

function updateBlockCandidate(pos)
{
	var spacerWidth=(paramObj.vetricalBlockWidth+paramObj.vetricalBlockSpacerWidth);
	var spacerHeight=(paramObj.fontHeight*paramObj.interlinearFactor*(paramObj.horizBlockRowCount+1) );	
	var xIdx=Math.floor(pos.x/spacerWidth);
	var yIdx=Math.floor(pos.y/(paramObj.fontHeight*paramObj.interlinearFactor*(paramObj.horizBlockRowCount)));

	blockCandidate= {
		x:xIdx*spacerWidth,
		y:yIdx*spacerHeight,
		width:paramObj.vetricalBlockWidth,
		height:(paramObj.fontHeight*paramObj.interlinearFactor*(paramObj.horizBlockRowCount))
		}
}

$(document).ready(function() {
	$("#do").click(function() {
		canvas=$("#mainCanvas").get(0);
		context=canvas.getContext("2d");		
		window.paramObj=readParams();
		blocks=[];
		mainLoop();
	});
	

	$("#mainCanvas").mousedown(function(e) {
		var x = e.pageX - this.offsetLeft;
		var y = e.pageY - this.offsetTop;
		updateBlockCandidate({x:x,y:y});		
		mousePressed=true;
	});
	
	$("#mainCanvas").mouseup(function(e) {
        var x = e.pageX - this.offsetLeft;
        var y = e.pageY - this.offsetTop;
		updateBlockCandidate({x:x,y:y});
		if(blockCandidate)
			blocks.push(blockCandidate);
		blockCandidate=null;
		mousePressed=false;
		mainLoop();
	});
	
	$("#mainCanvas").mousemove(function(e) {
		if(mousePressed) {
	        var x = e.pageX - this.offsetLeft;
	        var y = e.pageY - this.offsetTop;
			updateBlockCandidate({x:x,y:y});			
			mainLoop();
		}
	});

});




</script>

</head>
<body>

<div id="paramForm">
Общая ширина: <input type="text" id="fullWidth" value="960px"></input><br>
Общая высота: <input type="text" id="fullHeight" value="2000px"></input><br>
Высота шрифта: <input type="text" id="fontHeight" value="12pt"></input><br>
Междустрочный интервал: <input type="text" id="interlinearFactor" value="1.5"></input><br>
Высота строки: <span id="rowHeight"></span>
Строк в горизонтальном блоке: <input type="text" id="horizBlockRowCount" value="3"></input><br>
Количество вертикальных блоков: <input type="text" id="vetricalBlockCount" value="12"></input><br>
Ширина вертикального блока: <input type="text" id="vetricalBlockWidth" value="120px"></input><br>
Расстояние между блоками: <input type="text" id="vetricalBlockSpacerWidth" value="15px"></input><br>
<button id="do">Создать канвас</button>
</div>
<canvas id="mainCanvas" style="border: 1px solid;">
</canvas>
</body>
</html>